<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>作業區 - 庚新宇宙</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .homework-item {
            margin-bottom: 20px;
            animation: fadeIn 0.5s ease forwards;
        }
        .homework-status {
            display: inline-block;
            margin-left: 10px;
        }
        .homework-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        .homework-filter {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .submission-status {
            margin-top: 10px;
            font-weight: 500;
        }
        .due-date {
            color: #666;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        .due-soon {
            color: #ff9800;
        }
        .overdue {
            color: #f44336;
        }
        #homework-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .admin-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        @media (max-width: 768px) {
            #homework-list {
                grid-template-columns: 1fr;
            }
            .admin-controls {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <h1>庚新宇宙</h1>
            </div>
            <nav id="main-nav">
                <ul>
                    <li><a href="../index.html">首頁</a></li>
                    <li><a href="announcements.html">最新公告</a></li>
                    <li><a href="homework.html" class="active">作業區</a></li>
                    <li><a href="photo-album.html">相簿</a></li>
                    <li><a href="message-board.html">留言板</a></li>
                    <li><a href="calendar.html">行事曆</a></li>
                    <li id="user-status"><a href="login.html">登入/註冊</a></li>
                </ul>
            </nav>
            <div class="mobile-menu-toggle">
                <i class="fas fa-bars"></i>
            </div>
        </header>

        <main>
            <section class="page-header">
                <h2>作業區</h2>
                <p>查看和繳交班級作業</p>
            </section>

            <!-- 教師控制區域 -->
            <section id="homework-admin" style="display: none;">
                <div class="admin-controls">
                    <button id="add-homework-btn" class="btn btn-primary"><i class="fas fa-plus"></i> 新增作業</button>
                    <a href="homework-grading.html" class="btn btn-secondary"><i class="fas fa-graduation-cap"></i> 作業評分系統</a>
                </div>
            </section>

            <!-- 作業列表 -->
            <section class="homework-section">
                <div class="homework-filter">
                    <select id="homework-status-filter" class="form-select">
                        <option value="all">全部作業</option>
                        <option value="active">進行中</option>
                        <option value="completed">已截止</option>
                    </select>
                    <select id="homework-filter" class="form-select">
                        <option value="all">所有狀態</option>
                        <option value="pending">未繳交</option>
                        <option value="submitted">已繳交</option>
                        <option value="graded">已評分</option>
                    </select>
                </div>

                <div class="homework-list" id="homework-list">
                    <!-- 作業項目將通過 JavaScript 動態加載 -->
                    <div id="loading-indicator" class="text-center">
                        <div class="loader"></div>
                        <p>載入作業中...</p>
                    </div>
                </div>
            </section>

            <!-- 新增作業表單模態框 -->
            <div id="homework-modal" class="modal-overlay">
                <div class="modal">
                    <div class="modal-header">
                        <h3>新增作業</h3>
                        <button class="modal-close">&times;</button>
                    </div>
                    <div class="modal-content">
                        <form id="homework-form">
                            <div class="form-group">
                                <label for="homework-title">作業標題</label>
                                <input type="text" id="homework-title" required>
                            </div>
                            <div class="form-group">
                                <label for="homework-description">作業說明</label>
                                <textarea id="homework-description" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="homework-due-date">截止日期</label>
                                <input type="datetime-local" id="homework-due-date" required>
                            </div>
                            <div class="form-group">
                                <label for="homework-max-score">滿分</label>
                                <input type="number" id="homework-max-score" min="1" value="100" required>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary modal-close-btn">取消</button>
                        <button id="save-homework-btn" class="btn btn-primary">儲存</button>
                    </div>
                </div>
            </div>

            <!-- 繳交作業表單模態框 -->
            <div id="submit-homework-modal" class="modal-overlay">
                <div class="modal">
                    <div class="modal-header">
                        <h3>繳交作業</h3>
                        <button class="modal-close">&times;</button>
                    </div>
                    <div class="modal-content">
                        <form id="submit-homework-form">
                            <div class="form-group">
                                <label for="homework-answer">作業內容</label>
                                <textarea id="homework-answer" placeholder="請輸入作業內容或上傳檔案"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="homework-file">附加檔案 (選填)</label>
                                <input type="file" id="homework-file">
                                <small class="text-muted">支援的檔案格式: PDF, Word, Excel, 圖片等 (最大 10MB)</small>
                            </div>
                            <button type="submit" id="submit-homework-btn" class="btn btn-primary">提交</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 評分作業表單模態框 -->
            <div id="grade-homework-modal" class="modal-overlay">
                <div class="modal">
                    <div class="modal-header">
                        <h3>評分作業</h3>
                        <button class="modal-close">&times;</button>
                    </div>
                    <div class="modal-content">
                        <form id="grade-homework-form">
                            <div class="form-group">
                                <label for="homework-score">分數</label>
                                <input type="number" id="homework-score" min="0" required>
                            </div>
                            <div class="form-group">
                                <label for="homework-feedback">評語</label>
                                <textarea id="homework-feedback"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary modal-close-btn">取消</button>
                        <button id="save-grade-btn" class="btn btn-primary">儲存</button>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <div class="footer-content">
                <div class="footer-section">
                    <h3>庚新宇宙</h3>
                    <p>為班級提供一個便捷的信息共享平台</p>
                </div>
                <div class="footer-section">
                    <h3>聯絡我們</h3>
                    <p><i class="fas fa-envelope"></i> jim20130131@gmail.com</p>
                    <p><i class="fas fa-phone"></i> 886-966-258-238</p>
                </div>
                <div class="footer-section">
                    <h3>快速連結</h3>
                    <ul>
                        <li><a href="../index.html">首頁</a></li>
                        <li><a href="announcements.html">最新公告</a></li>
                        <li><a href="homework.html">作業區</a></li>
                        <li><a href="photo-album.html">相簿</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 庚新宇宙 - 保留所有權利</p>
            </div>
        </footer>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <!-- Cloudinary SDK -->
    <script src="https://cdn.jsdelivr.net/npm/cloudinary-core@2.3.0/cloudinary-core-shrinkwrap.min.js"></script>
    
    <!-- 自定義JavaScript -->
    <script src="../js/firebase-config.js"></script>
    <script src="../js/cloudinary-config.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 初始化導航欄
            initNavigation();
            
            // 載入作業列表
            loadHomeworks();
            
            // 檢查用戶角色，顯示/隱藏教師控制項
            auth.onAuthStateChanged(user => {
                if (user) {
                    getCurrentUserRole().then(role => {
                        if (role === 'teacher') {
                            document.getElementById('homework-admin').style.display = 'block';
                        }
                    });
                }
            });
            
            // 作業狀態過濾器事件
            document.getElementById('homework-status-filter').addEventListener('change', function() {
                loadHomeworks(this.value);
            });
            
            // 新增作業按鈕事件
            const addHomeworkBtn = document.getElementById('add-homework-btn');
            const homeworkModal = document.getElementById('homework-modal');
            
            addHomeworkBtn.addEventListener('click', () => {
                // 清空表單
                document.getElementById('homework-title').value = '';
                document.getElementById('homework-description').value = '';
                document.getElementById('homework-due-date').value = '';
                document.getElementById('homework-max-score').value = '100';
                
                // 顯示模態框
                homeworkModal.classList.add('active');
            });
            
            // 關閉模態框
            document.querySelectorAll('.modal-close, .modal-cancel').forEach(element => {
                element.addEventListener('click', () => {
                    document.querySelectorAll('.modal-overlay').forEach(modal => {
                        modal.classList.remove('active');
                    });
                });
            });
            
            // 儲存作業
            document.getElementById('save-homework-btn').addEventListener('click', () => {
                const title = document.getElementById('homework-title').value.trim();
                const description = document.getElementById('homework-description').value.trim();
                const dueDate = document.getElementById('homework-due-date').value;
                const maxScore = document.getElementById('homework-max-score').value;
                
                if (!title || !description || !dueDate || !maxScore) {
                    alert('請填寫所有欄位');
                    return;
                }
                
                const saveBtn = document.getElementById('save-homework-btn');
                saveBtn.disabled = true;
                saveBtn.textContent = '儲存中...';
                
                // 獲取當前用戶資料
                getCurrentUserData().then(userData => {
                    if (!userData) {
                        alert('請先登入');
                        homeworkModal.classList.remove('active');
                        return;
                    }
                    
                    // 新增作業到 Firestore
                    db.collection('homeworks').add({
                        title: title,
                        description: description,
                        dueDate: new Date(dueDate),
                        maxScore: parseInt(maxScore),
                        teacherId: auth.currentUser.uid,
                        teacherName: userData.username,
                        createdAt: timestamp()
                    })
                    .then(() => {
                        homeworkModal.classList.remove('active');
                        showAlert('作業已成功發布');
                        loadHomeworks(); // 重新載入作業列表
                    })
                    .catch(error => {
                        console.error('新增作業錯誤:', error);
                        alert('發布作業時發生錯誤');
                    })
                    .finally(() => {
                        saveBtn.disabled = false;
                        saveBtn.textContent = '儲存';
                    });
                });
            });
            
            // 提交作業
            document.getElementById('submit-homework-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const submitBtn = document.getElementById('submit-homework-btn');
                const originalText = submitBtn.textContent;
                
                // 從按鈕的data屬性獲取作業ID
                const homeworkId = submitBtn.dataset.homeworkId;
                
                // 調試信息
                console.log('提交作業，作業ID:', homeworkId);
                console.log('currentHomeworkId:', currentHomeworkId);
                
                if (!homeworkId) {
                    alert('無法獲取作業ID，請重新整理頁面後再試');
                    return;
                }
                
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 提交中...';
                
                const answer = document.getElementById('homework-answer').value.trim();
                const file = document.getElementById('homework-file').files[0];
                
                if (!answer && !file) {
                    alert('請填寫作業內容或上傳檔案');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    return;
                }
                
                // 檢查用戶是否為學生
                getCurrentUserRole().then(role => {
                    if (role !== 'student') {
                        showAlert('只有學生可以提交作業', 'danger');
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                        return;
                    }
                    
                    // 準備提交數據
                    const submissionData = {
                        homeworkId: homeworkId,
                        studentId: auth.currentUser.uid,
                        answer: answer,
                        submittedAt: timestamp(),
                        status: 'submitted'
                    };
                    
                    // 如果有文件，先上傳文件
                    if (file) {
                        const fileInput = document.getElementById('homework-file');
                        
                        // 檢查文件大小
                        if (file.size > 10 * 1024 * 1024) { // 10MB
                            showAlert('文件大小不能超過10MB', 'danger');
                            submitBtn.disabled = false;
                            submitBtn.textContent = originalText;
                            return;
                        }
                        
                        // 創建進度提示
                        const progressContainer = document.createElement('div');
                        progressContainer.className = 'upload-progress';
                        progressContainer.innerHTML = `
                            <div class="progress-label">上傳中... <span>0%</span></div>
                            <div class="progress-bar">
                                <div class="progress-bar-fill" style="width: 0%"></div>
                            </div>
                        `;
                        document.querySelector('.modal-content').appendChild(progressContainer);
                        
                        // 使用 Cloudinary 上傳
                        const formData = new FormData();
                        formData.append('file', file);
                        formData.append('upload_preset', cloudinaryConfig.uploadPreset);
                        formData.append('folder', 'homework_submissions');
                        
                        // 顯示上傳進度
                        const xhr = new XMLHttpRequest();
                        xhr.open('POST', `https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/upload`, true);
                        
                        // 監聽上傳進度
                        xhr.upload.onprogress = function(e) {
                            if (e.lengthComputable) {
                                const percent = Math.round((e.loaded / e.total) * 100);
                                progressContainer.querySelector('.progress-bar-fill').style.width = percent + '%';
                                progressContainer.querySelector('.progress-label span').textContent = percent + '%';
                            }
                        };
                        
                        xhr.onload = function() {
                            if (xhr.status === 200) {
                                try {
                                    const response = JSON.parse(xhr.responseText);
                                    
                                    // 添加文件信息到提交數據
                                    submissionData.fileURL = response.secure_url;
                                    submissionData.fileName = file.name;
                                    
                                    // 提交作業
                                    submitHomework(submissionData, submitBtn);
                                } catch (error) {
                                    console.error('解析上傳響應錯誤:', error);
                                    showAlert('文件上傳失敗: 無法解析響應', 'danger');
                                    submitBtn.disabled = false;
                                    submitBtn.textContent = originalText;
                                }
                            } else {
                                console.error('上傳錯誤:', xhr.responseText);
                                let errorMessage = '文件上傳失敗';
                                
                                try {
                                    const errorResponse = JSON.parse(xhr.responseText);
                                    if (errorResponse.error && errorResponse.error.message) {
                                        errorMessage += ': ' + errorResponse.error.message;
                                        
                                        // 特別處理 Cloudinary 未簽名上傳預設錯誤
                                        if (errorResponse.error.message.includes('Upload preset must be whitelisted for unsigned uploads')) {
                                            errorMessage = '上傳預設未配置為允許未簽名上傳。請在 Cloudinary 控制台中將上傳預設 "' + 
                                                cloudinaryConfig.uploadPreset + '" 設置為允許未簽名上傳。\n\n' +
                                                '設置步驟：\n' +
                                                '1. 登入 Cloudinary 控制台\n' +
                                                '2. 進入 Settings > Upload 頁面\n' +
                                                '3. 在 Upload presets 部分，找到或創建 "' + cloudinaryConfig.uploadPreset + '" 預設\n' +
                                                '4. 確保 "Signing Mode" 設置為 "Unsigned"';
                                        }
                                    }
                                } catch (e) {
                                    // 解析錯誤訊息失敗，使用默認錯誤訊息
                                }
                                
                                showAlert(errorMessage, 'danger');
                                submitBtn.disabled = false;
                                submitBtn.textContent = originalText;
                                progressContainer.remove();
                            }
                        };
                        
                        xhr.onerror = function() {
                            console.error('上傳請求錯誤');
                            showAlert('文件上傳失敗: 網絡錯誤', 'danger');
                            submitBtn.disabled = false;
                            submitBtn.textContent = originalText;
                            progressContainer.remove();
                        };
                        
                        xhr.send(formData);
                    } else {
                        // 沒有文件，直接提交作業
                        submitHomework(submissionData, submitBtn);
                    }
                }).catch(error => {
                    console.error('獲取用戶角色錯誤:', error);
                    showAlert('獲取用戶角色時發生錯誤', 'danger');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                });
            });
            
            // 提交作業到 Firestore
            function submitHomework(submissionData, submitBtn) {
                // 檢查是否已經提交過
                db.collection('homework_submissions')
                    .where('homeworkId', '==', submissionData.homeworkId)
                    .where('studentId', '==', submissionData.studentId)
                    .get()
                    .then(snapshot => {
                        let submissionRef;
                        
                        if (!snapshot.empty) {
                            // 已經提交過，更新提交
                            submissionRef = db.collection('homework_submissions').doc(snapshot.docs[0].id);
                        } else {
                            // 新提交
                            submissionRef = db.collection('homework_submissions').doc();
                        }
                        
                        return submissionRef.set(submissionData, { merge: true });
                    })
                    .then(() => {
                        showAlert('作業提交成功', 'success');
                        document.getElementById('submit-homework-modal').classList.remove('active');
                        
                        // 重新載入作業列表
                        const status = document.getElementById('homework-filter').value;
                        loadHomeworks(status);
                    })
                    .catch(error => {
                        console.error('提交作業錯誤:', error);
                        
                        // 處理常見的 Firestore 錯誤
                        if (error.code === 'permission-denied') {
                            alert('權限不足: 您可能沒有提交作業的權限。請參考 firebase-security-rules.md 文件設置 Firestore 安全規則。');
                        } else if (error.code === 'unavailable') {
                            alert('服務不可用: 請檢查您的網絡連接，或稍後再試。');
                        } else if (error.code === 'unauthenticated') {
                            alert('未認證: 請重新登入後再試。');
                        }
                        
                        showAlert('提交作業時發生錯誤', 'danger');
                    })
                    .finally(() => {
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    });
            }
            
            // 繳交作業
            document.getElementById('submit-homework-btn').addEventListener('click', function() {
                const homeworkId = this.dataset.homeworkId;
                openSubmitModal(homeworkId);
            });
            
            // 查看評語
            document.querySelectorAll('.view-feedback-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const submissionId = this.dataset.submissionId;
                    viewFeedback(submissionId);
                });
            });
            
            // 編輯作業
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const homeworkId = this.dataset.homeworkId;
                    editHomework(homeworkId);
                });
            });
            
            // 查看繳交情況
            document.querySelectorAll('.view-submissions-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const homeworkId = this.dataset.homeworkId;
                    window.location.href = `homework-submissions.html?id=${homeworkId}`;
                });
            });
        });
        
        // 載入作業列表
        function loadHomeworks(status = 'all') {
            const homeworkList = document.getElementById('homework-list');
            homeworkList.innerHTML = '<div id="loading-indicator" class="text-center"><div class="loader"></div><p>載入作業中...</p></div>';
            
            let query = db.collection('homeworks').orderBy('dueDate', 'desc');
            
            query.get().then(snapshot => {
                if (snapshot.empty) {
                    homeworkList.innerHTML = '<div class="no-data animate-fade-in"><p>目前沒有作業</p></div>';
                    return;
                }
                
                homeworkList.innerHTML = '';
                
                const now = new Date();
                let homeworksData = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    data.dueDate = data.dueDate.toDate();
                    
                    // 根據篩選條件過濾
                    if (status === 'active' && data.dueDate < now) {
                        return;
                    }
                    if (status === 'completed' && data.dueDate >= now) {
                        return;
                    }
                    
                    homeworksData.push(data);
                });
                
                // 檢查用戶角色和作業繳交狀態
                const user = auth.currentUser;
                if (user) {
                    // 獲取用戶角色
                    getCurrentUserRole().then(role => {
                        if (role === 'student') {
                            // 獲取學生的作業繳交狀態
                            db.collection('homework_submissions')
                                .where('studentId', '==', user.uid)
                                .get()
                                .then(submissionsSnapshot => {
                                    const submissions = {};
                                    submissionsSnapshot.forEach(doc => {
                                        const submission = doc.data();
                                        submissions[submission.homeworkId] = submission;
                                    });
                                    
                                    // 渲染作業列表
                                    renderHomeworkList(homeworksData, role, submissions);
                                })
                                .catch(error => {
                                    console.error('獲取作業繳交狀態錯誤:', error);
                                    renderHomeworkList(homeworksData, role, {});
                                });
                        } else {
                            // 教師角色，直接渲染作業列表
                            renderHomeworkList(homeworksData, role, {});
                        }
                    });
                } else {
                    // 未登入用戶
                    renderHomeworkList(homeworksData, null, {});
                }
            }).catch(error => {
                console.error('獲取作業列表錯誤:', error);
                homeworkList.innerHTML = '<p class="error-message">載入作業列表時發生錯誤</p>';
            });
        }
        
        // 渲染作業列表
        function renderHomeworkList(homeworks, userRole, submissions) {
            const homeworkList = document.getElementById('homework-list');
            homeworkList.innerHTML = '';
            
            if (homeworks.length === 0) {
                homeworkList.innerHTML = '<div class="no-data animate-fade-in"><p>目前沒有作業</p></div>';
                return;
            }
            
            homeworks.forEach(homework => {
                const homeworkItem = document.createElement('div');
                homeworkItem.className = 'card homework-item animate-fade-in';
                
                // 檢查截止日期
                const now = new Date();
                const dueDate = homework.dueDate;
                const isOverdue = dueDate < now;
                const isDueSoon = !isOverdue && (dueDate - now) < (3 * 24 * 60 * 60 * 1000); // 3天內
                
                // 檢查提交狀態
                let submissionStatus = '未繳交';
                let submissionStatusClass = 'badge-danger';
                let submissionId = null;
                
                if (userRole === 'student' && submissions) {
                    const submission = submissions[homework.id];
                    if (submission) {
                        submissionId = submission.id;
                        if (submission.status === 'graded') {
                            submissionStatus = `已評分: ${submission.score}分`;
                            submissionStatusClass = 'badge-success';
                        } else {
                            submissionStatus = '已繳交';
                            submissionStatusClass = 'badge-primary';
                        }
                    }
                }
                
                // 格式化日期
                const formattedDueDate = formatDate(dueDate);
                const dueDateClass = isOverdue 
                    ? 'overdue' 
                    : (isDueSoon ? 'due-soon' : '');
                
                homeworkItem.innerHTML = `
                    <div class="card-header">
                        <h3>${homework.title}
                            ${isOverdue 
                                ? '<span class="badge badge-danger">已截止</span>' 
                                : '<span class="badge badge-primary">進行中</span>'}
                        </h3>
                    </div>
                    <div class="card-content">
                        <p>${homework.description}</p>
                        <p class="due-date ${dueDateClass}">
                            <i class="fas fa-clock"></i> 截止日期: ${formattedDueDate} ${dueDate.getHours().toString().padStart(2, '0')}:${dueDate.getMinutes().toString().padStart(2, '0')}
                        </p>
                        ${userRole === 'student' ? 
                            `<div class="submission-status">
                                <span class="badge ${submissionStatusClass}">${submissionStatus}</span>
                            </div>` : ''}
                        <div class="homework-actions">
                            ${userRole === 'student' && !isOverdue ? 
                                `<button class="btn btn-primary btn-sm submit-btn" data-id="${homework.id}">
                                    <i class="fas fa-upload"></i> ${submissionStatus === '未繳交' ? '繳交作業' : '重新繳交'}
                                </button>` : ''}
                            ${userRole === 'student' && submissionStatus !== '未繳交' ? 
                                `<button class="btn btn-secondary btn-sm view-feedback-btn" data-id="${submissionId}">
                                    <i class="fas fa-comment-alt"></i> 查看評語
                                </button>` : ''}
                            ${userRole === 'teacher' ? 
                                `<button class="btn btn-primary btn-sm view-submissions-btn" data-id="${homework.id}">
                                    <i class="fas fa-users"></i> 查看繳交情況
                                </button>
                                <button class="btn btn-secondary btn-sm edit-btn" data-id="${homework.id}">
                                    <i class="fas fa-edit"></i> 編輯
                                </button>
                                <button class="btn btn-danger btn-sm delete-btn" data-id="${homework.id}">
                                    <i class="fas fa-trash"></i> 刪除
                                </button>` : ''}
                        </div>
                    </div>
                `;
                
                homeworkList.appendChild(homeworkItem);
                
                // 添加事件監聽器
                if (userRole === 'student' && !isOverdue) {
                    homeworkItem.querySelector('.submit-btn')?.addEventListener('click', function() {
                        openSubmitModal(homework.id);
                    });
                }
                
                if (userRole === 'student' && submissionStatus !== '未繳交') {
                    homeworkItem.querySelector('.view-feedback-btn')?.addEventListener('click', function() {
                        viewFeedback(submissionId);
                    });
                }
                
                if (userRole === 'teacher') {
                    homeworkItem.querySelector('.view-submissions-btn')?.addEventListener('click', function() {
                        window.location.href = `homework-submissions.html?id=${homework.id}`;
                    });
                    
                    homeworkItem.querySelector('.edit-btn')?.addEventListener('click', function() {
                        editHomework(homework.id);
                    });
                    
                    homeworkItem.querySelector('.delete-btn')?.addEventListener('click', function() {
                        if (confirm('確定要刪除此作業嗎？此操作無法復原。')) {
                            deleteHomework(homework.id);
                        }
                    });
                }
            });
            
            // 添加事件監聽器
            addEventListeners();
        }
        
        // 格式化日期
        function formatDate(date) {
            if (!(date instanceof Date)) {
                date = date.toDate(); // 如果是 Firestore Timestamp 對象
            }
            return `${date.getFullYear()}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}`;
        }
        
        // 添加事件監聽器
        function addEventListeners() {
            // 添加作業按鈕
            document.getElementById('add-homework-btn')?.addEventListener('click', function() {
                document.getElementById('homework-form').reset();
                document.querySelector('#homework-modal .modal-header h3').textContent = '新增作業';
                document.getElementById('homework-modal').classList.add('active');
            });
            
            // 關閉模態框按鈕
            document.querySelectorAll('.modal-close, .modal-close-btn').forEach(button => {
                button.addEventListener('click', function() {
                    this.closest('.modal-overlay').classList.remove('active');
                });
            });
            
            // 儲存作業按鈕
            document.getElementById('save-homework-btn')?.addEventListener('click', saveHomework);
            
            // 不需要這個事件監聽器，因為我們已經在表單上設置了 submit 事件
            
            // 儲存評分按鈕
            document.getElementById('save-grade-btn')?.addEventListener('click', saveGrade);
            
            // 過濾器
            document.getElementById('homework-status-filter')?.addEventListener('change', function() {
                const status = this.value;
                loadHomeworks(status);
            });
            
            document.getElementById('homework-filter')?.addEventListener('change', function() {
                const filter = this.value;
                filterHomeworks(filter);
            });
        }
        
        // 打開繳交作業模態框
        function openSubmitModal(homeworkId) {
            currentHomeworkId = homeworkId;
            console.log('打開提交模態框，作業ID:', homeworkId);
            
            // 重置表單
            document.getElementById('submit-homework-form').reset();
            
            // 將作業ID設置到提交按鈕的data屬性
            const submitBtn = document.getElementById('submit-homework-btn');
            submitBtn.dataset.homeworkId = homeworkId;
            
            // 顯示模態框
            document.getElementById('submit-homework-modal').classList.add('active');
        }
        
        // 提交作業
        function submitHomework(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submit-homework-btn');
            const originalText = submitBtn.textContent;
            
            // 調試信息
            console.log('currentHomeworkId:', currentHomeworkId);
            
            if (!currentHomeworkId) {
                alert('無法獲取作業ID，請重新整理頁面後再試');
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 提交中...';
            
            const answer = document.getElementById('homework-answer').value.trim();
            const file = document.getElementById('homework-file').files[0];
            
            if (!answer && !file) {
                alert('請填寫作業內容或上傳檔案');
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                return;
            }
            
            // 檢查是否已經有提交記錄
            db.collection('submissions')
                .where('homeworkId', '==', currentHomeworkId)
                .where('userId', '==', currentUser.uid)
                .get()
                .then(snapshot => {
                    const batch = db.batch();
                    
                    // 如果已經有提交，則更新
                    if (!snapshot.empty) {
                        const submissionDoc = snapshot.docs[0];
                        batch.update(submissionDoc.ref, {
                            answer: answer,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            status: 'submitted'
                        });
                        
                        if (file) {
                            uploadFile(file, submissionDoc.id, batch);
                        } else {
                            commitBatch(batch);
                        }
                    } else {
                        // 否則創建新的提交
                        const submissionRef = db.collection('submissions').doc();
                        batch.set(submissionRef, {
                            homeworkId: currentHomeworkId,
                            userId: currentUser.uid,
                            userName: currentUser.displayName,
                            answer: answer,
                            submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            status: 'submitted'
                        });
                        
                        if (file) {
                            uploadFile(file, submissionRef.id, batch);
                        } else {
                            commitBatch(batch);
                        }
                    }
                })
                .catch(error => {
                    console.error('提交作業時發生錯誤:', error);
                    alert(`提交失敗: ${error.message}`);
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                });
        }
        
        // 上傳檔案到 Cloudinary
        function uploadFile(file, submissionId, batch) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', cloudinaryConfig.uploadPreset);
            formData.append('folder', 'homework_submissions');
            
            // 顯示上傳進度
            const progressContainer = document.createElement('div');
            progressContainer.className = 'progress-container';
            progressContainer.innerHTML = `
                <div class="progress-label">上傳中... <span>0%</span></div>
                <div class="progress-bar">
                    <div class="progress-bar-fill" style="width: 0%"></div>
                </div>
            `;
            document.getElementById('submit-homework-form').appendChild(progressContainer);
            
            const xhr = new XMLHttpRequest();
            xhr.open('POST', `https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/upload`, true);
            
            // 監聽上傳進度
            xhr.upload.onprogress = function(e) {
                if (e.lengthComputable) {
                    const percent = Math.round((e.loaded / e.total) * 100);
                    progressContainer.querySelector('.progress-bar-fill').style.width = percent + '%';
                    progressContainer.querySelector('.progress-label span').textContent = percent + '%';
                }
            };
            
            xhr.onload = function() {
                if (xhr.status === 200) {
                    const response = JSON.parse(xhr.responseText);
                    
                    // 更新提交記錄
                    db.collection('submissions').doc(submissionId).update({
                        fileUrl: response.secure_url,
                        fileName: file.name
                    }).then(() => {
                        commitBatch(batch);
                    }).catch(error => {
                        console.error('更新檔案 URL 時發生錯誤:', error);
                        alert(`檔案上傳成功，但更新記錄失敗: ${error.message}`);
                    });
                } else {
                    console.error('檔案上傳失敗:', xhr.responseText);
                    let errorMessage = '文件上傳失敗';
                    
                    try {
                        const errorResponse = JSON.parse(xhr.responseText);
                        if (errorResponse.error && errorResponse.error.message) {
                            errorMessage += ': ' + errorResponse.error.message;
                            
                            // 特別處理 Cloudinary 未簽名上傳預設錯誤
                            if (errorResponse.error.message.includes('Upload preset must be whitelisted for unsigned uploads')) {
                                errorMessage = '上傳預設未配置為允許未簽名上傳。請參考 firebase-security-rules.md 文件中的 Cloudinary 設置部分。';
                            }
                        }
                    } catch (e) {
                        // 解析錯誤訊息失敗，使用默認錯誤訊息
                    }
                    
                    alert(errorMessage, 'danger');
                    document.getElementById('submit-homework-btn').disabled = false;
                    document.getElementById('submit-homework-btn').textContent = '提交';
                    progressContainer.remove();
                }
            };
            
            xhr.onerror = function() {
                console.error('檔案上傳時發生網絡錯誤');
                alert('檔案上傳失敗: 網絡錯誤');
                document.getElementById('submit-homework-btn').disabled = false;
                document.getElementById('submit-homework-btn').textContent = '提交';
                progressContainer.remove();
            };
            
            xhr.send(formData);
        }
        
        // 提交批次操作
        function commitBatch(batch) {
            batch.commit()
                .then(() => {
                    alert('作業提交成功！');
                    document.getElementById('submit-homework-modal').classList.remove('active');
                    document.getElementById('submit-homework-btn').disabled = false;
                    document.getElementById('submit-homework-btn').textContent = '提交';
                    
                    // 重新載入作業列表
                    loadHomeworks(document.getElementById('homework-status-filter').value);
                    
                    // 移除進度條
                    const progressContainer = document.querySelector('.progress-container');
                    if (progressContainer) {
                        progressContainer.remove();
                    }
                })
                .catch(error => {
                    console.error('提交作業時發生錯誤:', error);
                    
                    // 處理特定的 Firestore 權限錯誤
                    if (error.code === 'permission-denied') {
                        alert('提交失敗: Firestore 權限不足。請確保您已正確設置 Firestore 安全規則。詳細說明請查看設置指南。');
                    } else {
                        alert(`提交失敗: ${error.message}`);
                    }
                    
                    document.getElementById('submit-homework-btn').disabled = false;
                    document.getElementById('submit-homework-btn').textContent = '提交';
                    
                    // 移除進度條
                    const progressContainer = document.querySelector('.progress-container');
                    if (progressContainer) {
                        progressContainer.remove();
                    }
                });
        }
        
        // 查看評語
        function viewFeedback(submissionId) {
            db.collection('submissions').doc(submissionId).get()
                .then(doc => {
                    if (!doc.exists) {
                        alert('找不到繳交記錄');
                        return;
                    }
                    
                    const submission = doc.data();
                    
                    // 獲取作業信息
                    db.collection('homeworks').doc(submission.homeworkId).get()
                        .then(homeworkDoc => {
                            if (!homeworkDoc.exists) {
                                alert('找不到作業信息');
                                return;
                            }
                            
                            const homework = homeworkDoc.data();
                            
                            // 創建模態框
                            const modal = document.createElement('div');
                            modal.className = 'modal-overlay active';
                            modal.innerHTML = `
                                <div class="modal">
                                    <div class="modal-header">
                                        <h3>作業評語</h3>
                                        <button class="modal-close">&times;</button>
                                    </div>
                                    <div class="modal-content">
                                        <div class="card">
                                            <div class="card-header">
                                                <h4>${homework.title}</h4>
                                            </div>
                                            <div class="card-content">
                                                <div class="feedback-section">
                                                    <p><strong>分數:</strong> <span class="badge ${submission.score >= homework.maxScore * 0.8 ? 'badge-success' : (submission.score >= homework.maxScore * 0.6 ? 'badge-primary' : 'badge-danger')}">${submission.score}/${homework.maxScore}</span></p>
                                                    <p><strong>評語:</strong> ${submission.feedback || '無評語'}</p>
                                                    <p><strong>繳交時間:</strong> ${formatDate(submission.submittedAt)} ${submission.submittedAt.toDate().getHours().toString().padStart(2, '0')}:${submission.submittedAt.toDate().getMinutes().toString().padStart(2, '0')}</p>
                                                    ${submission.gradedAt ? `<p><strong>評分時間:</strong> ${formatDate(submission.gradedAt)} ${submission.gradedAt.toDate().getHours().toString().padStart(2, '0')}:${submission.gradedAt.toDate().getMinutes().toString().padStart(2, '0')}</p>` : ''}
                                                </div>
                                                <div class="submission-content">
                                                    <h4>繳交內容:</h4>
                                                    <p>${submission.answer}</p>
                                                    ${submission.fileUrl ? `<p><a href="${submission.fileUrl}" target="_blank" class="btn btn-sm btn-secondary"><i class="fas fa-download"></i> 下載附件: ${submission.fileName}</a></p>` : ''}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                            
                            document.body.appendChild(modal);
                            
                            // 添加關閉按鈕事件
                            modal.querySelector('.modal-close').addEventListener('click', () => {
                                document.body.removeChild(modal);
                            });
                        })
                        .catch(error => {
                            console.error('獲取作業信息錯誤:', error);
                            alert(`獲取作業信息時發生錯誤: ${error.message}`);
                        });
                })
                .catch(error => {
                    console.error('獲取繳交記錄錯誤:', error);
                    alert(`獲取繳交記錄時發生錯誤: ${error.message}`);
                });
        }
        
        // 編輯作業
        function editHomework(homeworkId) {
            db.collection('homeworks').doc(homeworkId).get()
                .then(doc => {
                    if (!doc.exists) {
                        alert('找不到作業');
                        return;
                    }
                    
                    const homework = doc.data();
                    currentHomeworkId = homeworkId;
                    
                    // 設置模態框標題
                    document.querySelector('#homework-modal .modal-header h3').textContent = '編輯作業';
                    
                    // 填充表單
                    document.getElementById('homework-title').value = homework.title;
                    document.getElementById('homework-description').value = homework.description;
                    
                    // 格式化日期時間為 YYYY-MM-DDTHH:MM 格式
                    const dueDate = homework.dueDate.toDate();
                    const year = dueDate.getFullYear();
                    const month = (dueDate.getMonth() + 1).toString().padStart(2, '0');
                    const day = dueDate.getDate().toString().padStart(2, '0');
                    const hours = dueDate.getHours().toString().padStart(2, '0');
                    const minutes = dueDate.getMinutes().toString().padStart(2, '0');
                    document.getElementById('homework-due-date').value = `${year}-${month}-${day}T${hours}:${minutes}`;
                    
                    document.getElementById('homework-max-score').value = homework.maxScore;
                    
                    // 顯示模態框
                    document.getElementById('homework-modal').classList.add('active');
                })
                .catch(error => {
                    console.error('獲取作業信息錯誤:', error);
                    alert(`獲取作業信息時發生錯誤: ${error.message}`);
                });
        }
        
        // 儲存作業
        function saveHomework() {
            const title = document.getElementById('homework-title').value;
            const description = document.getElementById('homework-description').value;
            const dueDateStr = document.getElementById('homework-due-date').value;
            const maxScore = parseInt(document.getElementById('homework-max-score').value);
            
            if (!title || !description || !dueDateStr || isNaN(maxScore)) {
                alert('請填寫所有必填欄位');
                return;
            }
            
            const dueDate = new Date(dueDateStr);
            
            const saveBtn = document.getElementById('save-homework-btn');
            const originalText = saveBtn.textContent;
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 儲存中...';
            
            const homeworkData = {
                title: title,
                description: description,
                dueDate: firebase.firestore.Timestamp.fromDate(dueDate),
                maxScore: maxScore,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // 如果是編輯現有作業
            if (currentHomeworkId) {
                db.collection('homeworks').doc(currentHomeworkId).update(homeworkData)
                    .then(() => {
                        alert('作業更新成功！');
                        document.getElementById('homework-modal').classList.remove('active');
                        saveBtn.disabled = false;
                        saveBtn.textContent = originalText;
                        currentHomeworkId = null;
                        
                        // 重新載入作業列表
                        loadHomeworks(document.getElementById('homework-status-filter').value);
                    })
                    .catch(error => {
                        console.error('更新作業時發生錯誤:', error);
                        
                        // 處理特定的 Firestore 權限錯誤
                        if (error.code === 'permission-denied') {
                            alert('更新失敗: Firestore 權限不足。請確保您已正確設置 Firestore 安全規則。詳細說明請查看設置指南。');
                        } else {
                            alert(`更新失敗: ${error.message}`);
                        }
                        
                        saveBtn.disabled = false;
                        saveBtn.textContent = originalText;
                    });
            } else {
                // 創建新作業
                homeworkData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                homeworkData.createdBy = currentUser.uid;
                homeworkData.teacherName = currentUser.displayName;
                
                db.collection('homeworks').add(homeworkData)
                    .then(() => {
                        alert('作業新增成功！');
                        document.getElementById('homework-modal').classList.remove('active');
                        saveBtn.disabled = false;
                        saveBtn.textContent = originalText;
                        
                        // 重新載入作業列表
                        loadHomeworks(document.getElementById('homework-status-filter').value);
                    })
                    .catch(error => {
                        console.error('新增作業時發生錯誤:', error);
                        
                        // 處理特定的 Firestore 權限錯誤
                        if (error.code === 'permission-denied') {
                            alert('新增失敗: Firestore 權限不足。請確保您已正確設置 Firestore 安全規則。詳細說明請查看設置指南。');
                        } else {
                            alert(`新增失敗: ${error.message}`);
                        }
                        
                        saveBtn.disabled = false;
                        saveBtn.textContent = originalText;
                    });
            }
        }
        
        // 刪除作業
        function deleteHomework(homeworkId) {
            const confirmDelete = confirm('確定要刪除此作業嗎？此操作無法復原。');
            if (!confirmDelete) return;
            
            db.collection('homeworks').doc(homeworkId).delete()
                .then(() => {
                    alert('作業已刪除');
                    
                    // 重新載入作業列表
                    loadHomeworks(document.getElementById('homework-status-filter').value);
                })
                .catch(error => {
                    console.error('刪除作業時發生錯誤:', error);
                    
                    // 處理特定的 Firestore 權限錯誤
                    if (error.code === 'permission-denied') {
                        alert('刪除失敗: Firestore 權限不足。請確保您已正確設置 Firestore 安全規則。詳細說明請查看設置指南。');
                    } else {
                        alert(`刪除失敗: ${error.message}`);
                    }
                });
        }
        
        // 評分作業
        function openGradeModal(submissionId) {
            currentSubmissionId = submissionId;
            
            db.collection('submissions').doc(submissionId).get()
                .then(doc => {
                    if (!doc.exists) {
                        alert('找不到繳交記錄');
                        return;
                    }
                    
                    const submission = doc.data();
                    
                    // 填充表單
                    if (submission.score) {
                        document.getElementById('homework-score').value = submission.score;
                    } else {
                        document.getElementById('homework-score').value = '';
                    }
                    
                    if (submission.feedback) {
                        document.getElementById('homework-feedback').value = submission.feedback;
                    } else {
                        document.getElementById('homework-feedback').value = '';
                    }
                    
                    // 顯示模態框
                    document.getElementById('grade-homework-modal').classList.add('active');
                })
                .catch(error => {
                    console.error('獲取繳交記錄錯誤:', error);
                    alert(`獲取繳交記錄時發生錯誤: ${error.message}`);
                });
        }
        
        // 儲存評分
        function saveGrade() {
            const score = parseInt(document.getElementById('homework-score').value);
            const feedback = document.getElementById('homework-feedback').value;
            
            if (isNaN(score)) {
                alert('請輸入有效的分數');
                return;
            }
            
            const saveBtn = document.getElementById('save-grade-btn');
            const originalText = saveBtn.textContent;
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 儲存中...';
            
            db.collection('submissions').doc(currentSubmissionId).update({
                score: score,
                feedback: feedback,
                status: 'graded',
                gradedAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                alert('評分已儲存');
                document.getElementById('grade-homework-modal').classList.remove('active');
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                currentSubmissionId = null;
                
                // 重新載入繳交列表（如果在繳交頁面）
                if (window.location.href.includes('homework-submissions.html')) {
                    loadSubmissions();
                }
            })
            .catch(error => {
                console.error('儲存評分時發生錯誤:', error);
                
                // 處理特定的 Firestore 權限錯誤
                if (error.code === 'permission-denied') {
                    alert('儲存失敗: Firestore 權限不足。請確保您已正確設置 Firestore 安全規則。詳細說明請查看設置指南。');
                } else {
                    alert(`儲存失敗: ${error.message}`);
                }
                
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            });
        }
        
        // 過濾作業
        function filterHomeworks(filter) {
            const homeworkItems = document.querySelectorAll('.homework-item');
            
            if (filter === 'all') {
                homeworkItems.forEach(item => {
                    item.style.display = 'block';
                });
                return;
            }
            
            homeworkItems.forEach(item => {
                const statusBadge = item.querySelector('.submission-status .badge');
                if (!statusBadge) {
                    item.style.display = 'block';
                    return;
                }
                
                const status = statusBadge.textContent.trim();
                
                if (filter === 'pending' && status === '未繳交') {
                    item.style.display = 'block';
                } else if (filter === 'submitted' && status === '已繳交') {
                    item.style.display = 'block';
                } else if (filter === 'graded' && status.includes('已評分')) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        // 初始化頁面
        document.addEventListener('DOMContentLoaded', function() {
            // 檢查用戶登入狀態
            firebase.auth().onAuthStateChanged(function(user) {
                if (user) {
                    // 用戶已登入
                    currentUser = user;
                    
                    // 更新導航欄
                    document.getElementById('user-status').innerHTML = `
                        <a href="profile.html">
                            <i class="fas fa-user"></i> ${user.displayName || '個人資料'}
                        </a>
                    `;
                    
                    // 檢查用戶角色
                    db.collection('users').doc(user.uid).get()
                        .then(doc => {
                            if (doc.exists) {
                                const userData = doc.data();
                                currentUserRole = userData.role || 'student';
                                
                                // 如果是教師，顯示管理控制項
                                if (currentUserRole === 'teacher') {
                                    document.getElementById('homework-admin').style.display = 'block';
                                }
                                
                                // 載入作業列表
                                loadHomeworks('all');
                            } else {
                                console.error('找不到用戶資料');
                                currentUserRole = 'student';
                                loadHomeworks('all');
                            }
                        })
                        .catch(error => {
                            console.error('獲取用戶資料時發生錯誤:', error);
                            currentUserRole = 'student';
                            loadHomeworks('all');
                        });
                } else {
                    // 用戶未登入
                    currentUser = null;
                    currentUserRole = 'guest';
                    loadHomeworks('all');
                }
            });
            
            // 添加事件監聽器
            addEventListeners();
        });
    </script>
</body>
</html>
